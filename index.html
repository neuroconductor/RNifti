<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fast R and C++ Access to NIfTI Images • RNifti</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Fast R and C++ Access to NIfTI Images">
<meta property="og:description" content="Provides very fast read and write access to images stored
        in the NIfTI-1, NIfTI-2 and ANALYZE-7.5 formats, with seamless
        synchronisation of in-memory image objects between compiled C
        and interpreted R code. Also provides a simple image viewer,
        and a C/C++ API that can be used by other packages. Not to be
        confused with RNiftyReg, which performs image registration
        and applies spatial transformations.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">RNifti</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.3.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jonclayden/RNifti/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">


<div id="rnifti-fast-r-and-c-access-to-nifti-images" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#rnifti-fast-r-and-c-access-to-nifti-images" class="anchor" aria-hidden="true"></a>RNifti: Fast R and C++ Access to NIfTI Images</h1></div>
<p>The <a href="https://www.nitrc.org/docman/view.php/26/64/nifti1.h" class="external-link">NIfTI-1 format</a> is a popular file format for storing medical imaging data, widely used in medical research and related fields. Conceptually, a NIfTI-1 file incorporates multidimensional numeric data, like an R <code>array</code>, but with additional metadata describing the real-space resolution of the image, the physical orientation of the image, and how the image should be interpreted. The <a href="https://www.nitrc.org/docman/view.php/26/1302/nifti2_doc.html" class="external-link">NIfTI-2 format</a> was a later revision mostly to use wider data types for very large images.</p>
<p>There are several packages available for reading and writing NIfTI-1 files in R, and these are summarised in the <a href="https://cran.r-project.org/view=MedicalImaging" class="external-link">Medical Imaging task view</a>. However, <code>RNifti</code> is distinguished by its</p>
<ul>
<li>
<a href="#performance">extremely strong performance</a>, in terms of speed;</li>
<li>
<a href="#api">C/C++ API</a>, allowing access to NIfTI images in compiled code in other R packages, or even in <a href="#use-in-pure-c-projects">standalone C++ code</a>; and</li>
<li>modest dependencies, consisting of only R itself and the very widely-used <a href="https://cran.r-project.org/package=Rcpp" class="external-link">Rcpp</a> C++ wrapper library.</li>
</ul>
<p>The latest development version of the package can always be installed from GitHub using the <code>remotes</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## install.packages("remotes")</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"jonclayden/RNifti"</span><span class="op">)</span></code></pre></div>
<p><strong>Please note that the <code>RNifti</code> package is to be used for research purposes only, and is not a clinical tool. It comes with no warranty.</strong></p>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor" aria-hidden="true"></a>Usage</h2>
<p>The primary role of <code>RNifti</code> is to read and write NIfTI-1 and (since package version 1.2.0) NIfTI-2 files, either <code>gzip</code>-compressed or uncompressed, and provide access to image data and metadata. An image may be read into R using the <code>readNifti</code> function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jonclayden/RNifti" class="external-link">RNifti</a></span><span class="op">)</span>
<span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/readNifti.html">readNifti</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"example.nii.gz"</span>, package<span class="op">=</span><span class="st">"RNifti"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>This image is an R array with some additional attributes containing information such as its dimensions and the size of its pixels (or voxels, in this case, since it is a 3D image). There are auxiliary functions for extracting this information: the standard <code><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim()</a></code>, plus <code><a href="reference/pixdim.html">pixdim()</a></code> and <code><a href="reference/pixdim.html">pixunits()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
<span class="co">## [1] 96 96 60</span>
<span class="fu"><a href="reference/pixdim.html">pixdim</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
<span class="co">## [1] 2.5 2.5 2.5</span>
<span class="fu"><a href="reference/pixdim.html">pixunits</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
<span class="co">## [1] "mm" "s"</span></code></pre></div>
<p>So this image is of size 96 x 96 x 60 voxels, with each voxel representing 2.5 x 2.5 x 2.5 mm in real space. (The temporal unit, seconds here, only applies to the fourth dimension, if it is present.) Replacement versions of the latter functions are also available, for modifying the metadata.</p>
<p>The package contains a basic image viewer, which can be used interactively or noninteractively to examine 2D or 3D images.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/view.html">view</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/unnamed-chunk-5-1.png" alt=""><p class="caption">plot of chunk unnamed-chunk-5</p>
</div>
<p>By default, the viewer shows labels indicating <a href="#image-orientation">image orientation</a>, crosshairs pinpointing the currently selected location, the numerical indices of the current location, and the value of the image at that location. Options allow each of these to be turned off, for the content of the bottom-right panel to be customised entirely, for the colour scale to be changed, and for additional images to be layered on top of the base image. See <code><a href="reference/view.html">?view</a></code> for details.</p>
<p>A fuller list of the raw metadata stored in the file can be obtained using the <code>niftiHeader</code> function.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/niftiHeader.html">niftiHeader</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
<span class="co">## NIfTI-1 header</span>
<span class="co">##     sizeof_hdr: 348</span>
<span class="co">##       dim_info: 0</span>
<span class="co">##            dim: 3  96  96  60  1  1  1  1</span>
<span class="co">##      intent_p1: 0</span>
<span class="co">##      intent_p2: 0</span>
<span class="co">##      intent_p3: 0</span>
<span class="co">##    intent_code: 0 (Unknown)</span>
<span class="co">##       datatype: 8 (INT32)</span>
<span class="co">##         bitpix: 32</span>
<span class="co">##    slice_start: 0</span>
<span class="co">##         pixdim: -1.0  2.5  2.5  2.5  0.0  0.0  0.0  0.0</span>
<span class="co">##     vox_offset: 352</span>
<span class="co">##      scl_slope: 0</span>
<span class="co">##      scl_inter: 0</span>
<span class="co">##      slice_end: 0</span>
<span class="co">##     slice_code: 0 (Unknown)</span>
<span class="co">##     xyzt_units: 10</span>
<span class="co">##        cal_max: 2503</span>
<span class="co">##        cal_min: 0</span>
<span class="co">## slice_duration: 0</span>
<span class="co">##        toffset: 0</span>
<span class="co">##        descrip: TractoR NIfTI writer v3.0.0</span>
<span class="co">##       aux_file: </span>
<span class="co">##     qform_code: 2 (Aligned Anat)</span>
<span class="co">##     sform_code: 2 (Aligned Anat)</span>
<span class="co">##      quatern_b: 0</span>
<span class="co">##      quatern_c: 1</span>
<span class="co">##      quatern_d: 0</span>
<span class="co">##      qoffset_x: 122.0339</span>
<span class="co">##      qoffset_y: -95.18523</span>
<span class="co">##      qoffset_z: -55.03814</span>
<span class="co">##         srow_x: -2.5000  0.0000  0.0000  122.0339</span>
<span class="co">##         srow_y: 0.00000  2.50000  0.00000  -95.18523</span>
<span class="co">##         srow_z: 0.00000  0.00000  2.50000  -55.03814</span>
<span class="co">##    intent_name: </span>
<span class="co">##          magic: n+1</span></code></pre></div>
<p>Advanced users who know the NIfTI format well may want to alter elements of this metadata directly, and this can be performed using the <code>$</code> operator shorthand, as in</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">image</span><span class="op">$</span><span class="va">intent_code</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">image</span><span class="op">$</span><span class="va">intent_code</span>
<span class="co">## [1] 1</span></code></pre></div>
<p>If you need to modify multiple metadata elements at once, or replace metadata wholesale with new information from another image, the <code>asNifti</code> function provides a more efficient interface. See <code><a href="reference/asNifti.html">?asNifti</a></code> for details.</p>
<p>An image can be written back to NIfTI-1 format using the <code>writeNifti</code> function. <code>gzip</code> compression will be used if the specified file name ends with “.gz”.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/writeNifti.html">writeNifti</a></span><span class="op">(</span><span class="va">image</span>, <span class="st">"file.nii.gz"</span><span class="op">)</span></code></pre></div>
</div>
<div id="image-orientation" class="section level2">
<h2 class="hasAnchor">
<a href="#image-orientation" class="anchor" aria-hidden="true"></a>Image orientation</h2>
<p>The NIfTI-1 and NIfTI-2 formats have a mechanism for indicating the physical orientation and location of the image volume in real space. The reference orientation has the left–right direction aligned with the x-axis, the posterior–anterior (back–front) direction aligned with the y-axis, and the inferior–superior (bottom–top) direction aligned with the z-axis; but “xform” information stored with an image can describe a transformation from that coordinate system to the one used by that particular image, in the form of an affine matrix. To obtain the full xform matrix for an image, call the <code>xform</code> function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/xform.html">xform</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
<span class="co">##      [,1] [,2] [,3]      [,4]</span>
<span class="co">## [1,] -2.5  0.0  0.0 122.03390</span>
<span class="co">## [2,]  0.0  2.5  0.0 -95.18523</span>
<span class="co">## [3,]  0.0  0.0  2.5 -55.03814</span>
<span class="co">## [4,]  0.0  0.0  0.0   1.00000</span>
<span class="co">## attr(,"code")</span>
<span class="co">## [1] 2</span></code></pre></div>
<p>Just the rotation with respect to the canonical axes can be obtained with the <code>rotation</code> function:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/xform.html">rotation</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
<span class="co">##      [,1] [,2] [,3]</span>
<span class="co">## [1,]   -1    0    0</span>
<span class="co">## [2,]    0    1    0</span>
<span class="co">## [3,]    0    0    1</span></code></pre></div>
<p>In this case, the image is flipped along the x-axis relative to the canonical axes, so the positive x-direction points towards the left rather than the right. This is compactly represented by the output of the <code>orientation</code> function, which indicates the approximate real-world directions of the positive axes in each dimension.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/xform.html">orientation</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
<span class="co">## [1] "LAS"</span></code></pre></div>
<p>So, here, “LAS” means that the positive x-axis points left, the positive y-axis anterior and the positive z-axis superior. This is the so-called “radiological” orientation convention, and can be requested when viewing images for those who are used to it:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/view.html">view</a></span><span class="op">(</span><span class="va">image</span>, radiological<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/unnamed-chunk-12-1.png" alt=""><p class="caption">plot of chunk unnamed-chunk-12</p>
</div>
<p>Notice the left (L) and right (R) labels, relative to the view shown above. Setting the <code>radiologicalView</code> option to <code>TRUE</code> will make this the default for all future views.</p>
<p>There is a replacement version of the <code>orientation</code> function, which will reorient the image to align with the requested directions. This is a relatively complex operation, affecting the xform and the storage order of the data.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">image</span><span class="op">[</span><span class="fl">50</span>,<span class="fl">39</span>,<span class="fl">23</span><span class="op">]</span>
<span class="co">## [1] 300</span>
<span class="fu"><a href="reference/xform.html">orientation</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"RAS"</span>
<span class="fu"><a href="reference/xform.html">xform</a></span><span class="op">(</span><span class="va">image</span><span class="op">)</span>
<span class="co">##      [,1] [,2] [,3]       [,4]</span>
<span class="co">## [1,]  2.5  0.0  0.0 -115.46610</span>
<span class="co">## [2,]  0.0  2.5  0.0  -95.18523</span>
<span class="co">## [3,]  0.0  0.0  2.5  -55.03814</span>
<span class="co">## [4,]  0.0  0.0  0.0    1.00000</span>
<span class="co">## attr(,"code")</span>
<span class="co">## [1] 2</span>
<span class="va">image</span><span class="op">[</span><span class="fl">50</span>,<span class="fl">39</span>,<span class="fl">23</span><span class="op">]</span>
<span class="co">## [1] 310</span>
<span class="va">image</span><span class="op">[</span><span class="fl">47</span>,<span class="fl">39</span>,<span class="fl">23</span><span class="op">]</span>
<span class="co">## [1] 300</span></code></pre></div>
<p>Notice that the sign of the top-left element of the xform has now flipped, and the value of the image at location (50,39,23) has changed because the data has been reordered. The equivalent x-location is now 47, which is the 50th element counting in the other direction (96 - 50 + 1 = 47).</p>
<p>This latter operation can be useful to ensure that indexing into several images with different native storage conventions will end up always having approximately the same meaning (and it is performed internally by the viewer, if required). It is non-destructive, because no interpolation of the data is performed. This means that the axes will not exactly align with the requested directions if the original image was oblique to the canonical axes, but conversely it ensures that no degradation in the image will result. (The <a href="https://github.com/jonclayden/RNiftyReg" class="external-link"><code>RNiftyReg</code> package</a> can be used to apply an arbitrary rotation to an image and interpolate the data onto the new grid, if required.)</p>
</div>
<div id="support-for-composite-types" class="section level2">
<h2 class="hasAnchor">
<a href="#support-for-composite-types" class="anchor" aria-hidden="true"></a>Support for composite types</h2>
<p>The NIfTI standard supports composite types such as complex-valued and RGB images, and support for these was added in version 1.0.0 of this package. Complex data is exposed to R using the standard <code>complex</code> vector type:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/readNifti.html">readNifti</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"example.nii.gz"</span>, package<span class="op">=</span><span class="st">"RNifti"</span><span class="op">)</span><span class="op">)</span>
<span class="va">complexImage</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/asNifti.html">asNifti</a></span><span class="op">(</span><span class="va">image</span> <span class="op">+</span> <span class="fl">0i</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">complexImage</span><span class="op">)</span>
<span class="co">## Image array of mode "complex" (8.4 Mb)</span>
<span class="co">## - 96 x 96 x 60 voxels</span>
<span class="co">## - 2.5 x 2.5 x 2.5 mm per voxel</span>
<span class="va">complexImage</span><span class="op">[</span><span class="fl">50</span>,<span class="fl">39</span>,<span class="fl">23</span><span class="op">]</span>
<span class="co">## [1] 300+0i</span></code></pre></div>
<p>R’s native representation for RGB values is <a href="https://en.wikipedia.org/wiki/Web_colors" class="external-link">CSS-style hex strings</a> of character mode, which are reasonably space-efficient (8 or 10 bytes per value) but a little clunky to work with. For efficiency of interchange between R and the NIfTI-internal datatypes, <code>RNifti</code> uses a byte-packed representation of integer mode instead, which takes up 4 bytes per value. Of course, the viewer understands this format.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rgbImage</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/readNifti.html">readNifti</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"example_rgb.nii.gz"</span>, package<span class="op">=</span><span class="st">"RNifti"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">rgbImage</span><span class="op">)</span>
<span class="co">## Image array of mode "integer" (2.1 Mb)</span>
<span class="co">## - 96 x 96 x 60 voxels</span>
<span class="co">## - 2.5 x 2.5 x 2.5 mm per voxel</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">rgbImage</span><span class="op">)</span>
<span class="co">## [1] "niftiImage" "rgbArray"   "array"</span>
<span class="fu"><a href="reference/view.html">view</a></span><span class="op">(</span><span class="va">rgbImage</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="tools/figures/unnamed-chunk-15-1.png" alt=""><p class="caption">plot of chunk unnamed-chunk-15</p>
</div>
<p>Notice that values are shown in the viewer using R’s conventional hex string format, but the data is of class <code>rgbArray</code>. The function of the same name can be used to create these arrays from strings or channel values, for the purposes of building RGB images from data, while the <code>as.character</code> method and <code>channels</code> function perform the opposite conversions.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">rgbImage</span>, flatten<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">[</span><span class="fl">50</span>,<span class="fl">39</span>,<span class="fl">23</span><span class="op">]</span>
<span class="co">## [1] "#1F5B8A"</span>
<span class="fu"><a href="reference/channels.html">channels</a></span><span class="op">(</span><span class="va">rgbImage</span>, <span class="st">"red"</span><span class="op">)</span><span class="op">[</span><span class="fl">50</span>,<span class="fl">39</span>,<span class="fl">23</span>,<span class="fl">1</span><span class="op">]</span>
<span class="co">## red </span>
<span class="co">##  31</span></code></pre></div>
<p>RGB images with an alpha (opacity) channel are also supported.</p>
</div>
<div id="performance" class="section level2">
<h2 class="hasAnchor">
<a href="#performance" class="anchor" aria-hidden="true"></a>Performance</h2>
<p>The <code>RNifti</code> package uses the robust and widely used <a href="https://www.nitrc.org/projects/nifti/" class="external-link">NIfTI reference implementation</a>, which is written in C, to read and write NIfTI files. It also uses the standard NIfTI-2 data structure as its canonical representation of an image in memory. Together, these make the package extremely fast, as the following benchmark against packages <a href="https://cran.r-project.org/package=AnalyzeFMRI" class="external-link"><code>AnalyzeFMRI</code></a>, <a href="https://github.com/ANTsX/ANTsRCore" class="external-link"><code>ANTsRCore</code></a>, <a href="https://cran.r-project.org/package=neuroim" class="external-link"><code>neuroim</code></a>, <a href="https://cran.r-project.org/package=oro.nifti" class="external-link"><code>oro.nifti</code></a> and <a href="https://cran.r-project.org/package=tractor.base" class="external-link"><code>tractor.base</code></a> shows.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html" class="external-link">installed.packages</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AnalyzeFMRI"</span>,<span class="st">"ANTsRCore"</span>,<span class="st">"neuroim"</span>,<span class="st">"oro.nifti"</span>,<span class="st">"RNifti"</span>,
                       <span class="st">"tractor.base"</span><span class="op">)</span>, <span class="st">"Version"</span><span class="op">]</span>
<span class="co">##  AnalyzeFMRI    ANTsRCore      neuroim    oro.nifti       RNifti tractor.base </span>
<span class="co">##     "1.1-21"      "0.7.3"      "0.0.6"      "0.9.1"      "1.0.0"      "3.3.2"</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">microbenchmark</span><span class="op">)</span>
<span class="fu">microbenchmark</span><span class="op">(</span><span class="fu">AnalyzeFMRI</span><span class="fu">::</span><span class="fu">f.read.volume</span><span class="op">(</span><span class="st">"example.nii"</span><span class="op">)</span>,
               <span class="fu">ANTsRCore</span><span class="fu">::</span><span class="fu">antsImageRead</span><span class="op">(</span><span class="st">"example.nii"</span><span class="op">)</span>,
               <span class="fu">neuroim</span><span class="fu">::</span><span class="fu">loadVolume</span><span class="op">(</span><span class="st">"example.nii"</span><span class="op">)</span>,
               <span class="fu">oro.nifti</span><span class="fu">::</span><span class="fu">readNIfTI</span><span class="op">(</span><span class="st">"example.nii"</span><span class="op">)</span>,
               <span class="fu">RNifti</span><span class="fu">::</span><span class="fu"><a href="reference/readNifti.html">readNifti</a></span><span class="op">(</span><span class="st">"example.nii"</span><span class="op">)</span>,
               <span class="fu">RNifti</span><span class="fu">::</span><span class="fu"><a href="reference/readNifti.html">readNifti</a></span><span class="op">(</span><span class="st">"example.nii"</span>, internal<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,
               <span class="fu">tractor.base</span><span class="fu">::</span><span class="fu">readImageFile</span><span class="op">(</span><span class="st">"example.nii"</span><span class="op">)</span>, unit<span class="op">=</span><span class="st">"ms"</span><span class="op">)</span>
<span class="co">## Unit: milliseconds</span>
<span class="co">##                                               expr       min        lq</span>
<span class="co">##          AnalyzeFMRI::f.read.volume("example.nii") 10.650034 10.785712</span>
<span class="co">##            ANTsRCore::antsImageRead("example.nii")  1.174784  1.553855</span>
<span class="co">##                 neuroim::loadVolume("example.nii") 16.496942 17.202503</span>
<span class="co">##                oro.nifti::readNIfTI("example.nii") 23.323140 26.900033</span>
<span class="co">##                   RNifti::readNifti("example.nii")  1.309286  1.432574</span>
<span class="co">##  RNifti::readNifti("example.nii", internal = TRUE)  0.155987  0.218652</span>
<span class="co">##         tractor.base::readImageFile("example.nii")  8.020815  8.512061</span>
<span class="co">##        mean     median         uq         max neval</span>
<span class="co">##  12.5975294 10.9189280 11.2826610  142.469529   100</span>
<span class="co">##  12.5234012  1.6563580  1.7609965 1087.252412   100</span>
<span class="co">##  31.0333107 23.2155850 25.1907460  847.043278   100</span>
<span class="co">##  50.4967592 29.4253275 32.0777185  434.736898   100</span>
<span class="co">##   1.6504420  1.5129170  1.7070565    5.564642   100</span>
<span class="co">##   0.3028081  0.2976415  0.3680695    0.768533   100</span>
<span class="co">##  26.8987791 10.4609615 13.3785205  180.474982   100</span></code></pre></div>
<p>With a median runtime of less than 2 ms, <code>RNifti</code> is typically around ten times as fast as the alternatives to read this image into R. The exception is <code>ANTsRCore</code>, which uses a similar low-level pointer-based arrangement as <code>RNifti</code>, and is therefore comparable in speed. However, <code>ANTsRCore</code> has substantial dependencies, which may affect its suitability in some applications.</p>
<p>Moreover, when reading the file into an “internal” image, which does not copy the pixel values into R data structures until they are required, the median runtime drops by a further 80%, to just 300 µs. This saves time and memory, while still allowing data access through standard R indexing operations.</p>
</div>
<div id="implementation-details" class="section level2">
<h2 class="hasAnchor">
<a href="#implementation-details" class="anchor" aria-hidden="true"></a>Implementation details</h2>
<p>The package does not fully duplicate the NIfTI structure’s contents in R-visible objects. Instead, it passes key metadata back to R, such as the image dimensions and pixel dimensions, and it also passes back the pixel values where they are needed. Finally, it creates an <a href="http://r-manuals.flakery.org/R-exts.html#External-pointers-and-weak-references" class="external-link">external pointer</a> to the native data structure, which is stored in an attribute. This pointer is dereferenced whenever the object is passed back to the C++ code, thereby avoiding unnecessary duplication and ensuring that all metadata remains intact. The full NIfTI-1 header can be obtained using the <code>niftiHeader</code> R function, if it is needed.</p>
<p>This arrangement is efficient and generally works well, but certain R operations strip attributes—in which case the external pointer will be removed. The internal structure will be built again when necessary, but using default metadata. In these cases, if it is important to keep the original metadata, the <code>asNifti</code> function should be called explicitly, with a template object. This reconstructs the NIfTI data structure, using the template as a starting point.</p>
</div>
<div id="api" class="section level2">
<h2 class="hasAnchor">
<a href="#api" class="anchor" aria-hidden="true"></a>API</h2>
<p>It is possible to use the package’s NIfTI-handling code in other R packages’ compiled code, thereby obviating the need to duplicate the reference implementation. Moreover, <code>RNifti</code> provides two key C++ wrapper classes:</p>
<ul>
<li>
<code>NiftiImage</code>, which simplifies memory management and supports the package’s internal image pointers and associated reference counting, and</li>
<li>
<code>NiftiImageData</code>, which encapsulates the pixel data within an image, and handles datatype multiplexing and data scaling, as well as providing indexing, iterators and other niceties.</li>
</ul>
<p>Full doxygen documentation for these classes is available at <a href="http://doxygen.flakery.org/RNifti/" class="external-link uri">http://doxygen.flakery.org/RNifti/</a>, and is also provided with package releases.</p>
<p>A third-party package can use the <code>NiftiImage</code> class by including</p>
<pre><code>LinkingTo: Rcpp, RNifti</code></pre>
<p>in its <code>DESCRIPTION</code> file, and then including the <code>RNifti.h</code> header file. For example,</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1"></a><span class="pp">#include </span><span class="im">"RNifti.h"</span></span>
<span id="cb18-2"><a href="#cb18-2"></a></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="dt">void</span> myfunction ()</span>
<span id="cb18-4"><a href="#cb18-4"></a>{</span>
<span id="cb18-5"><a href="#cb18-5"></a>    RNifti::NiftiImage image(<span class="st">"example.nii.gz"</span>);</span>
<span id="cb18-6"><a href="#cb18-6"></a>    <span class="co">// Do something with the image</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>}</span></code></pre></div>
<p>If you’re using the <code>sourceCpp</code> function from <code>Rcpp</code>, you may also need to add the attribute line</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1"></a><span class="co">// [[Rcpp::depends(RNifti)]]</span></span></code></pre></div>
<p>to the top of your C++ source file.</p>
<p>In addition to the one taking a file path, there are also constructors taking a <code>SEXP</code> (i.e., an R object), another <code>NiftiImage</code>, or a <code>nifti_image</code> structure from the reference implementation. <code>NiftiImage</code> objects can be implicitly cast to pointers to <code>nifti_image</code> structs, meaning that they can be directly used in calls to the reference implementation’s own API. The latter is accessed through the separate <code>RNiftiAPI.h</code> header file.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1"></a><span class="pp">#include </span><span class="im">"RNifti.h"</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="pp">#include </span><span class="im">"RNiftiAPI.h"</span></span>
<span id="cb20-3"><a href="#cb20-3"></a></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="dt">void</span> myfunction (SEXP <span class="va">image_</span>)</span>
<span id="cb20-5"><a href="#cb20-5"></a>{</span>
<span id="cb20-6"><a href="#cb20-6"></a>    RNifti::NiftiImage image(<span class="va">image_</span>);</span>
<span id="cb20-7"><a href="#cb20-7"></a>    <span class="at">const</span> <span class="dt">size_t</span> volsize = nifti_get_volsize(image);</span>
<span id="cb20-8"><a href="#cb20-8"></a>}</span></code></pre></div>
<p>(<code>RNifti</code> will also have to be added to the <code>Imports</code> list in the package’s <code>DESCRIPTION</code> file, as well as <code>LinkingTo</code>.) The <code>RNiftiAPI.h</code> header should only be included once per package, since it contains function implementations. Multiple includes will lead to duplicate symbol warnings from your linker. Therefore, if multiple source files require access to the NIfTI-1 reference implementation, it is recommended that the API header be included alone in a separate “.c” or “.cpp” file, while others only include the main <code>RNifti.h</code>.</p>
<p><code>RNifti</code> is not specifically designed to be thread-safe, and R itself is expressly single-threaded. However, some effort has been made to try to minimise problems associated with parallelisation, such as putting R API calls within a critical region if OpenMP is being used. If you are using the API in a package that does use OpenMP or another form of threads, it is wise to preregister the functions exported by <code>RNifti</code> before use, by calling <code>niftilib_register_all()</code>. In single-threaded contexts this is optional, and will be performed when required.</p>
<p>Packages must choose which version of the NIfTI library to work with, since their definitions of the core <code>nifti_image</code> structure are incompatible. By default the NIfTI-1 version is used, but the NIfTI-2 version may be chosen instead by defining <code>RNIFTI_NIFTILIB_VERSION</code> to 2 before including <code>RNifti.h</code>. <a href="https://github.com/jonclayden/RNifti/blob/master/inst/include/RNifti.h" class="external-link">The header file</a> itself contains more detailed documentation. The <a href="https://github.com/jonclayden/RNifti/tree/master/clients" class="external-link"><code>clients</code> directory</a> has stub examples of packages using each version of the library.</p>
</div>
<div id="use-in-pure-c-projects" class="section level2">
<h2 class="hasAnchor">
<a href="#use-in-pure-c-projects" class="anchor" aria-hidden="true"></a>Use in pure C++ projects</h2>
<p>Thanks to contributions from <a href="https://github.com/soolijoo" class="external-link">Matt Hall</a>, it is possible (as of package version 0.7.0) to use the <code>NiftiImage</code> C++ class in standalone C++ projects. The <a href="https://github.com/jonclayden/RNifti/tree/master/standalone" class="external-link"><code>standalone</code> directory</a> provides a minimal example, and its contents can be copied to a new directory (including symlinked files) as a new project template.</p>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=RNifti">https://​cloud.r-project.org/​package=RNifti</a>
</li>
<li>Browse source code at <br><a href="https://github.com/jonclayden/RNifti/">https://​github.com/​jonclayden/​RNifti/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/jonclayden/RNifti/issues">https://​github.com/​jonclayden/​RNifti/​issues</a>
</li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/GPL-2">GPL-2</a></li>
</ul>
</div>


<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Jon Clayden <br><small class="roles"> Maintainer, author </small> <a href="https://orcid.org/0000-0002-6608-0619" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Bob Cox <br><small class="roles"> Author </small>  </li>
<li>Mark Jenkinson <br><small class="roles"> Author </small>  </li>
<li><a href="authors.html">More on authors...</a></li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=RNifti" class="external-link"><img src="http://www.r-pkg.org/badges/version/RNifti" alt="CRAN version"></a></li>
<li><a href="https://travis-ci.org/jonclayden/RNifti" class="external-link"><img src="https://travis-ci.org/jonclayden/RNifti.svg?branch=master" alt="Build Status"></a></li>
<li><a href="https://ci.appveyor.com/project/jonclayden/rnifti/branch/master" class="external-link"><img src="https://ci.appveyor.com/api/projects/status/ftoy9c6k0ne3ga12/branch/master?svg=true" alt="Build status"></a></li>
<li><a href="https://coveralls.io/github/jonclayden/RNifti?branch=master" class="external-link"><img src="https://coveralls.io/repos/github/jonclayden/RNifti/badge.svg?branch=master" alt="Coverage Status"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Jon Clayden, Bob Cox, Mark Jenkinson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
